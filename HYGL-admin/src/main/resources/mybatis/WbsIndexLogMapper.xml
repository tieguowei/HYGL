<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.resale.background.mapper.WbsIndexLogMapper" >
  <resultMap id="BaseResultMap" type="com.resale.background.pojo.WbsIndexLog" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="operatorName" property="operatorname" jdbcType="VARCHAR" />
    <result column="operatorImg" property="operatorimg" jdbcType="VARCHAR" />
    <result column="navigationId" property="navigationid" jdbcType="VARCHAR" />
    <result column="navigationName" property="navigationname" jdbcType="VARCHAR" />
    <result column="deptCode" property="deptcode" jdbcType="VARCHAR" />
    <result column="createTime" property="createtime" jdbcType="TIMESTAMP" />
    <result column="content" property="content" jdbcType="VARCHAR" />
    <result column="createdBy" property="createdby" jdbcType="INTEGER" />
    <result column="resourceId" property="resourceid" jdbcType="VARCHAR" />
    <result column="messageId" property="messageid" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Example_Where_Clause" >
    <where >
      <foreach collection="oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause" >
    <where >
      <foreach collection="example.oredCriteria" item="criteria" separator="or" >
        <if test="criteria.valid" >
          <trim prefix="(" suffix=")" prefixOverrides="and" >
            <foreach collection="criteria.criteria" item="criterion" >
              <choose >
                <when test="criterion.noValue" >
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue" >
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue" >
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue" >
                  and ${criterion.condition}
                  <foreach collection="criterion.value" item="listItem" open="(" close=")" separator="," >
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List" >
    id, operatorName, operatorImg, navigationId, navigationName, deptCode, createTime, 
    content, createdBy, resourceId, messageId
  </sql>
  <select id="selectByExample" resultMap="BaseResultMap" parameterType="com.resale.background.pojo.WbsIndexLogExample" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from wbs_index_log
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from wbs_index_log
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from wbs_index_log
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.resale.background.pojo.WbsIndexLogExample" >
    delete from wbs_index_log
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.resale.background.pojo.WbsIndexLog" >
    insert into wbs_index_log (id, operatorName, operatorImg, 
      navigationId, navigationName, deptCode, 
      createTime, content, createdBy, 
      resourceId, messageId)
    values (#{id,jdbcType=INTEGER}, #{operatorname,jdbcType=VARCHAR}, #{operatorimg,jdbcType=VARCHAR}, 
      #{navigationid,jdbcType=VARCHAR}, #{navigationname,jdbcType=VARCHAR}, #{deptcode,jdbcType=VARCHAR}, 
      #{createtime,jdbcType=TIMESTAMP}, #{content,jdbcType=VARCHAR}, #{createdby,jdbcType=INTEGER}, 
      #{resourceid,jdbcType=VARCHAR}, #{messageid,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.resale.background.pojo.WbsIndexLog" >
    insert into wbs_index_log
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="operatorname != null" >
        operatorName,
      </if>
      <if test="operatorimg != null" >
        operatorImg,
      </if>
      <if test="navigationid != null" >
        navigationId,
      </if>
      <if test="navigationname != null" >
        navigationName,
      </if>
      <if test="deptcode != null" >
        deptCode,
      </if>
      <if test="createtime != null" >
        createTime,
      </if>
      <if test="content != null" >
        content,
      </if>
      <if test="createdby != null" >
        createdBy,
      </if>
      <if test="resourceid != null" >
        resourceId,
      </if>
      <if test="messageid != null" >
        messageId,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="operatorname != null" >
        #{operatorname,jdbcType=VARCHAR},
      </if>
      <if test="operatorimg != null" >
        #{operatorimg,jdbcType=VARCHAR},
      </if>
      <if test="navigationid != null" >
        #{navigationid,jdbcType=VARCHAR},
      </if>
      <if test="navigationname != null" >
        #{navigationname,jdbcType=VARCHAR},
      </if>
      <if test="deptcode != null" >
        #{deptcode,jdbcType=VARCHAR},
      </if>
      <if test="createtime != null" >
        #{createtime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        #{content,jdbcType=VARCHAR},
      </if>
      <if test="createdby != null" >
        #{createdby,jdbcType=INTEGER},
      </if>
      <if test="resourceid != null" >
        #{resourceid,jdbcType=VARCHAR},
      </if>
      <if test="messageid != null" >
        #{messageid,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.resale.background.pojo.WbsIndexLogExample" resultType="java.lang.Integer" >
    select count(*) from wbs_index_log
    <if test="_parameter != null" >
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map" >
    update wbs_index_log
    <set >
      <if test="record.id != null" >
        id = #{record.id,jdbcType=INTEGER},
      </if>
      <if test="record.operatorname != null" >
        operatorName = #{record.operatorname,jdbcType=VARCHAR},
      </if>
      <if test="record.operatorimg != null" >
        operatorImg = #{record.operatorimg,jdbcType=VARCHAR},
      </if>
      <if test="record.navigationid != null" >
        navigationId = #{record.navigationid,jdbcType=VARCHAR},
      </if>
      <if test="record.navigationname != null" >
        navigationName = #{record.navigationname,jdbcType=VARCHAR},
      </if>
      <if test="record.deptcode != null" >
        deptCode = #{record.deptcode,jdbcType=VARCHAR},
      </if>
      <if test="record.createtime != null" >
        createTime = #{record.createtime,jdbcType=TIMESTAMP},
      </if>
      <if test="record.content != null" >
        content = #{record.content,jdbcType=VARCHAR},
      </if>
      <if test="record.createdby != null" >
        createdBy = #{record.createdby,jdbcType=INTEGER},
      </if>
      <if test="record.resourceid != null" >
        resourceId = #{record.resourceid,jdbcType=VARCHAR},
      </if>
      <if test="record.messageid != null" >
        messageId = #{record.messageid,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map" >
    update wbs_index_log
    set id = #{record.id,jdbcType=INTEGER},
      operatorName = #{record.operatorname,jdbcType=VARCHAR},
      operatorImg = #{record.operatorimg,jdbcType=VARCHAR},
      navigationId = #{record.navigationid,jdbcType=VARCHAR},
      navigationName = #{record.navigationname,jdbcType=VARCHAR},
      deptCode = #{record.deptcode,jdbcType=VARCHAR},
      createTime = #{record.createtime,jdbcType=TIMESTAMP},
      content = #{record.content,jdbcType=VARCHAR},
      createdBy = #{record.createdby,jdbcType=INTEGER},
      resourceId = #{record.resourceid,jdbcType=VARCHAR},
      messageId = #{record.messageid,jdbcType=VARCHAR}
    <if test="_parameter != null" >
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.resale.background.pojo.WbsIndexLog" >
    update wbs_index_log
    <set >
      <if test="operatorname != null" >
        operatorName = #{operatorname,jdbcType=VARCHAR},
      </if>
      <if test="operatorimg != null" >
        operatorImg = #{operatorimg,jdbcType=VARCHAR},
      </if>
      <if test="navigationid != null" >
        navigationId = #{navigationid,jdbcType=VARCHAR},
      </if>
      <if test="navigationname != null" >
        navigationName = #{navigationname,jdbcType=VARCHAR},
      </if>
      <if test="deptcode != null" >
        deptCode = #{deptcode,jdbcType=VARCHAR},
      </if>
      <if test="createtime != null" >
        createTime = #{createtime,jdbcType=TIMESTAMP},
      </if>
      <if test="content != null" >
        content = #{content,jdbcType=VARCHAR},
      </if>
      <if test="createdby != null" >
        createdBy = #{createdby,jdbcType=INTEGER},
      </if>
      <if test="resourceid != null" >
        resourceId = #{resourceid,jdbcType=VARCHAR},
      </if>
      <if test="messageid != null" >
        messageId = #{messageid,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.resale.background.pojo.WbsIndexLog" >
    update wbs_index_log
    set operatorName = #{operatorname,jdbcType=VARCHAR},
      operatorImg = #{operatorimg,jdbcType=VARCHAR},
      navigationId = #{navigationid,jdbcType=VARCHAR},
      navigationName = #{navigationname,jdbcType=VARCHAR},
      deptCode = #{deptcode,jdbcType=VARCHAR},
      createTime = #{createtime,jdbcType=TIMESTAMP},
      content = #{content,jdbcType=VARCHAR},
      createdBy = #{createdby,jdbcType=INTEGER},
      resourceId = #{resourceid,jdbcType=VARCHAR},
      messageId = #{messageid,jdbcType=VARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <!-- 根据日期和类型查询CRM系统的访问日志 -->
  <select id="getByDateAndContent" resultType="hashmap" parameterType="hashmap">
  	SELECT content,DATE_FORMAT(createTime,'%Y-%m-%d %H:%i:%s') createTime
	FROM wbs_index_log
	WHERE  DATE(createTime)=#{date}
	<if test="type ==1" >
        AND content LIKE "%导出客户信息记录%"
     </if>
     <if test="type ==2" >
        AND content LIKE "%导出预约单信息记录%"
     </if>
     <if test="type ==3" >
        AND content LIKE "%导出员工信息记录%"
     </if>
     <if test='type == null or type == ""' >
        AND content LIKE "%导出%信息记录%" 
     </if>
     ORDER BY createTime
  </select>
  
  <!-- 根据日期和类型查询CRM系统的访问日志的条数 -->
  <select id="countByDateAndContent" resultType="long" parameterType="hashmap">
  	SELECT count(1)
	FROM wbs_index_log
	WHERE  DATE(createTime)=#{date}
	<if test="type ==1" >
        AND content LIKE "%导出客户信息记录%"
     </if>
     <if test="type ==2" >
        AND content LIKE "%导出预约单信息记录%"
     </if>
     <if test="type ==3" >
        AND content LIKE "%导出员工信息记录%"
     </if>
     <if test='type == null or type == ""' >
        AND content LIKE "%导出%信息记录%" 
     </if>
  </select>
  
  <!-- 查询CRM导出和Log日志数目列表 -->
  <select id="getLogCountList" resultType="hashmap">
  	<![CDATA[
		SELECT b.date,
			CASE 
			WHEN a.logCount IS NULL THEN 0
			ELSE a.logCount
			END logCount,
			b.sqlCount,
		CASE 
		WHEN a.logCount=b.sqlCount THEN '正常'
		ELSE '异常' 
		END result
		FROM (
			SELECT DATE(createTime) date, COUNT(1) logCount
			FROM wbs_index_log
			WHERE content LIKE "%导出%信息记录%"
			GROUP BY DATE(createTime)
		) a
		RIGHT JOIN 
		(
			SELECT DATE(ts) date, COUNT(1) sqlCount
			FROM wbs_sql_log
			WHERE REPLACE(REPLACE(REPLACE(log,'\n',''),' ',''),'\t','') IN('selecta.id,a.no,a.investorId,a.faId,a.name,a.mobile,b.createTimeregisterTime,a.source,b.registerSource,a.assignReasonType,c.nameadvisorName,c.mobileadvisorMobile,c.independent,b.riskName,a.documentNo,a.documentNoType,a.type,c.identifiedAuth,c.deptCode,a.authStatus,a.province,a.city,b.weixinName,a.gender,a.email,a.address,a.contactTime,a.age,a.birthday,a.profession,a.investAmount,a.intention,a.investmentPreference,a.bank,a.bankAcount,a.hobby,a.memo,a.appMemo,b.signNum,b.signAmount/10000signAmount,a.shareRegisterSourceTitle,a.shareRegisterSource,a.createTime,a.oldAdvisorName,a.oldAdvisorMobilefromwbs_customeraleftjoinwbs_investorbona.mobile=b.mobileleftjoinwbs_employeecona.faId=c.idwherea.entId=225anddeleted=0',
						'selectr.id,r.entId,r.ifaId,r.faId,r.status,r.createTime,r.contractNo,r.signAmount,r.categoryProperty,r.currency,r.reservationAmount,r.no,r.productName,r.reservationDate,r.customerName,r.mobile,r.deptCode,r.productId,r.signDate,r.performanceDate,c.documentNo,r.memo,r.reserveSource,d.namedeptName,d.parentCodeparentCode,r.payDate,r.valueDate,r.expiryDate,r.expectedReturn,r.exchangeRate,r.signAmountForeignCurrency,visit.reVisitFunc,visit.reVisitResult,r.investorId,r.customerId,p.termType,p.newTemplate,r.categoryId,r.categoryName,r.repayPlanStatus,caser.statuswhen-1thenr.acceptRejectTimeelser.acceptTimeendasacceptOrRejectTime,caser.statuswhen-1thenr.auditRejectTimeelser.auditTimeendasauditOrRejectTime,caser.statuswhen-1thenr.rejectTimeelser.signDateendassignOrRejectTimefromwbs_prd_reservationrleftjoinwbs_employeeeonr.faId=e.idleftjoinwbs_employeefonr.ifaId=f.idleftjoinwbs_customerconr.customerId=c.idleftjoinwbs_departmentdonr.deptCode=d.Codeleftjoinwbs_productponr.productId=p.idleftjoinwbs_prd_revisit_logvisitonr.id=visit.prdResvIdandvisit.id=(selectidfromwbs_prd_revisit_logvisitlogwherevisitlog.prdResvId=r.idandvisitlog.deleted=0orderbyvisitTimedesclimit1)wherer.entId=225andr.productSource!=3and(r.deleted&1!=1orr.deleted=0)orderbyr.updateTi')
			GROUP BY DATE(ts)
		) b ON a.date=b.date
			ORDER BY date
		LIMIT 15
	]]>
  </select>
</mapper>